---
layout: page
title: Search
icon: fas fa-search
permalink: /search/
---

<h1 class="dynamic-title">
  <i class="{{ page.icon }} me-2"></i>{{ page.title }}
</h1>

<div class="search-page">
  <div class="search-box">
    <input id="my-search-q"
           class="form-control"
           type="search"
           placeholder="Search…"
           autocomplete="off" />

    <div class="search-hint text-muted mt-2" style="font-size:0.9rem;">
      Tip: try words like “core”, “pso”, “skill”, “install”…
    </div>
  </div>

  <!-- Dummy input, damit Chirpy-Search nicht crasht -->
  <input id="search-input"
         type="search"
         style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0;"
         aria-hidden="true"
         tabindex="-1" />

  <div id="my-search-status" class="text-muted mt-3"></div>
  <div id="my-search-groups" class="mt-3"></div>
</div>

<style>
  .search-page { max-width: 860px; }

  #my-search-groups section { margin-top: 22px; }

  #my-search-groups h2 {
    font-size: 1.25rem;
    margin: 0 0 10px 0;
  }

  #my-search-groups .search-results article {
    margin: 14px 0;
    padding: 12px 14px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    background: var(--bg-primary);
  }

  #my-search-groups .search-results h3 {
    margin: 0;
    font-size: 1.05rem;
  }

  #my-search-groups .search-results p {
    margin: 6px 0 0;
    opacity: .9;
    line-height: 1.35;
  }

  #my-search-groups .count {
    font-size: .95rem;
    opacity: .7;
  }
</style>

<script>
/* =========================================================
   SEARCH INDEX (direkt hier, keine externe Datei)
   - markdownify -> strip_html => "normaler Text"
   ========================================================= */
window.MY_SEARCH_INDEX = [
  {% assign first = true %}

  {% for post in site.posts %}
    {% unless first %},{% endunless %}
    {% assign first = false %}
    {
      collection: "posts",
      title: {{ post.title | jsonify }},
      url: {{ post.url | relative_url | jsonify }},
      content: {{ post.content | markdownify | strip_html | strip_newlines | replace: "  ", " " | jsonify }}
    }
  {% endfor %}

  {% for p in site.pages %}
    {% if p.title and p.url and p.url != "/" %}
      {% unless p.path contains "_tabs/" or p.path contains "assets/" or p.path contains "_includes/" or p.path contains "_layouts/" %}
        {% unless first %},{% endunless %}
        {% assign first = false %}
        {
          collection: "pages",
          title: {{ p.title | jsonify }},
          url: {{ p.url | relative_url | jsonify }},
          content: {{ p.content | markdownify | strip_html | strip_newlines | replace: "  ", " " | jsonify }}
        }
      {% endunless %}
    {% endif %}
  {% endfor %}

  {% assign wanted = "mods,wiki,tools,games" | split: "," %}
  {% for cname in wanted %}
    {% assign coll = site.collections | where: "label", cname | first %}
    {% if coll and coll.docs %}
      {% for doc in coll.docs %}
        {% if doc.title and doc.url %}
          {% unless first %},{% endunless %}
          {% assign first = false %}
          {
            collection: {{ cname | jsonify }},
            title: {{ doc.title | jsonify }},
            url: {{ doc.url | relative_url | jsonify }},
            content: {{ doc.content | markdownify | strip_html | strip_newlines | replace: "  ", " " | jsonify }}
          }
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endfor %}
];
</script>

<script>
/* =========================================================
   SEARCH LOGIC
   ========================================================= */
(() => {
  const input  = document.getElementById('my-search-q');
  const status = document.getElementById('my-search-status');
  const groups = document.getElementById('my-search-groups');

  const COLLECTION_META = {
    mods:  { label: 'Mods',         icon: 'fas fa-layer-group' },
    wiki:  { label: 'Sims 4 Wiki',   icon: 'fas fa-book' },
    tools: { label: 'Modding Tools', icon: 'fas fa-toolbox' },
    games: { label: 'Game Center',  icon: 'fas fa-puzzle-piece' },
    posts: { label: 'Blog',         icon: 'fas fa-pen-nib' },
    pages: { label: 'Pages',        icon: 'fas fa-file-lines' }
  };

  const ORDER = ['mods','wiki','tools','games','posts','pages'];
  const data = window.MY_SEARCH_INDEX || [];

  const esc = s => (s || '').replace(/[&<>"']/g, c =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
  );

  function cleanPreviewText(s) {
    return (s || '')
      .replace(/\u00A0/g, ' ')
      .replace(/\s+/g, ' ')
      // falls doch noch Markdown-Zeug durchrutscht:
      .replace(/(^|\s)#{1,6}\s+/g, ' ')
      .replace(/\*\*([^*]+)\*\*/g, '$1')
      .replace(/\*([^*]+)\*/g, '$1')
      .replace(/`([^`]+)`/g, '$1')
      .replace(/\[(.*?)\]\((.*?)\)/g, '$1')
      .trim();
  }

  function snippet(text, q) {
    const t = cleanPreviewText(text);
    if (!t) return '';
    if (!q) return t.slice(0,180) + (t.length>180?'…':'');

    const needle = q.toLowerCase();
    const low = t.toLowerCase();
    const i = low.indexOf(needle);

    if (i === -1) return t.slice(0,180) + (t.length>180?'…':'');

    const start = Math.max(0, i - 60);
    const end   = Math.min(t.length, i + needle.length + 100);

    return (start>0?'…':'') + t.slice(start, end) + (end<t.length?'…':'');
  }

  function render(grouped, q) {
    groups.innerHTML = '';
    if (!q) {
      status.textContent = `Index ready (${data.length} items). Type to search…`;
      return;
    }

    const total = Object.values(grouped).reduce((a,b)=>a+b.length,0);
    if (!total) {
      status.textContent = 'Oops! No results found.';
      return;
    }

    status.textContent = `${total} result${total===1?'':'s'} found.`;

    ORDER.forEach(key => {
      const items = grouped[key];
      if (!items || !items.length) return;

      const meta = COLLECTION_META[key] || { label: key, icon: 'fas fa-file-lines' };

      const sec = document.createElement('section');
      sec.innerHTML = `
        <h2>
          <i class="${meta.icon} me-2"></i>${meta.label}
          <span class="count text-muted">(${items.length})</span>
        </h2>
      `;

      const list = document.createElement('div');
      list.className = 'search-results';

      items.forEach(it => {
        const art = document.createElement('article');
        art.innerHTML = `
          <h3>
            <i class="${meta.icon} me-2 text-muted"></i>
            <a href="${esc(it.url)}">${esc(it.title)}</a>
          </h3>
          <p class="text-muted">${esc(snippet(it.content, q))}</p>
        `;
        list.appendChild(art);
      });

      sec.appendChild(list);
      groups.appendChild(sec);
    });
  }

  function search(q) {
    q = q.trim();
    if (!q) return render({}, '');

    const qlow = q.toLowerCase();
    const grouped = {};

    data.forEach(it => {
      const hay = ((it.title || '') + ' ' + (it.content || '')).toLowerCase();
      if (hay.includes(qlow)) {
        const key = it.collection || 'pages';
        (grouped[key] ||= []).push(it);
      }
    });

    // Titel-Treffer nach vorn
    Object.keys(grouped).forEach(k => {
      grouped[k].sort((a,b) => {
        const at = (a.title||'').toLowerCase().includes(qlow) ? 0 : 1;
        const bt = (b.title||'').toLowerCase().includes(qlow) ? 0 : 1;
        return at - bt;
      });
    });

    render(grouped, q);
  }

  input.addEventListener('input', e => search(e.target.value));
  render({}, '');
})();
</script>
