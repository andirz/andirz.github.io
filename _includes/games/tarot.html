{% assign tt_base = site.baseurl | append: "/assets/img/games/tarot/" %}

<div class="tt-root" data-tt>
  <style>
    .tt-wrap{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background:#020617; color:#e5e7eb;
      border-radius:24px; padding:2rem;
      border:1px solid #1e293b;
      box-shadow:0 30px 60px rgba(0,0,0,.35);
      max-width:900px; margin:2rem auto;
    }
    .tt-head{display:flex; gap:1rem; flex-wrap:wrap; justify-content:space-between; align-items:flex-start;}
    .tt-head h2{margin:0; font-weight:800;}
    .tt-sub{color:#94a3b8; margin:.25rem 0 0 0;}
    .tt-stats{display:flex; gap:.6rem; flex-wrap:wrap;}
    .tt-badge{
      background:#020617;
      border:1px solid #1e293b;
      border-radius:999px;
      padding:.35rem .85rem;
      font-weight:650;
    }
    .tt-prompt{margin:1.25rem 0; font-weight:650;}
    .tt-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(110px,1fr));
      gap:14px;
    }

    .tt-card{
      aspect-ratio:1/1.6;
      border-radius:16px;
      border:2px solid #1e293b;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:all .25s ease;
      background:#0b1220;
      position:relative;
      overflow:hidden;
      user-select:none;
    }
    .tt-card:hover{transform:translateY(-4px); border-color:#38bdf8;}
    .tt-card.disabled{
      opacity:.25;
      pointer-events:none;
      transform:none;
      border-color:#1e293b;
    }
    .tt-card img{
      width:90%;
      height:90%;
      object-fit:contain;
      display:block;
    }

    /* Card back – CSS only, no back.png */
    .tt-back{
      background:
        radial-gradient(circle at 20% 20%, rgba(56,189,248,.25), transparent 45%),
        radial-gradient(circle at 80% 30%, rgba(46,204,113,.18), transparent 55%),
        linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .tt-back::after{
      content:"?";
      font-size:2.2rem;
      font-weight:900;
      color:rgba(229,231,235,.85);
      text-shadow:0 10px 20px rgba(0,0,0,.4);
    }

    .tt-btn{
      margin-top:1.25rem;
      background:#1e293b;
      color:#e5e7eb;
      border:none;
      padding:.65rem 1.4rem;
      border-radius:14px;
      font-weight:800;
      cursor:pointer;
    }
    .tt-btn:hover{background:#334155;}
    .tt-note{
      color:#94a3b8;
      font-size:.95rem;
      margin-top:.5rem;
    }
  </style>

  <div class="tt-wrap">
    <div class="tt-head">
      <div>
        <h2>Tarot Trial</h2>
        <p class="tt-sub">
          Memorize the sequence, then click the cards in the correct order.
        </p>
      </div>
      <div class="tt-stats">
        <div class="tt-badge">Score: <span data-tt-score>0</span></div>
        <div class="tt-badge">Lives: <span data-tt-lives>3</span></div>
        <div class="tt-badge">Round: <span data-tt-round>1</span></div>
      </div>
    </div>

    <div class="tt-prompt" data-tt-prompt>Loading…</div>
    <div class="tt-grid" data-tt-grid></div>

    <button class="tt-btn" type="button" data-tt-restart>Restart</button>
    <div class="tt-note" data-tt-note></div>
  </div>
</div>

<script>
(function(){
  const roots = document.querySelectorAll('[data-tt]:not([data-tt-init])');
  if(!roots.length) return;

  const basePath = "{{ tt_base }}";

  const deck = [
    "advocate","chariot","coins","cups","death","emperor","empress","evil",
    "fool","hermit","high_spellcaster","judgment","justice","lovers","magician",
    "moon","star","strength","sun","suspension","swords","temperance",
    "tower","wands","wheel_of_fortune","world"
  ];

  function shuffle(a){ return [...a].sort(()=>Math.random()-0.5); }

  function placeholder(name){
    const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="300" height="460">
  <rect width="100%" height="100%" rx="28" fill="#0b1220"/>
  <text x="50%" y="48%" text-anchor="middle"
        font-size="28" fill="#94a3b8"
        font-family="system-ui" font-weight="700">${name}</text>
</svg>`;
    return "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg);
  }

  roots.forEach(root => {
    root.setAttribute('data-tt-init','1');

    const grid   = root.querySelector('[data-tt-grid]');
    const prompt = root.querySelector('[data-tt-prompt]');
    const scoreE = root.querySelector('[data-tt-score]');
    const livesE = root.querySelector('[data-tt-lives]');
    const roundE = root.querySelector('[data-tt-round]');
    const note   = root.querySelector('[data-tt-note]');
    const btn    = root.querySelector('[data-tt-restart]');

    let score=0, lives=3, round=1;
    let solution=[], index=0, locked=true, timer;

    function update(){
      scoreE.textContent = score;
      livesE.textContent = lives;
      roundE.textContent = round;
    }

    function card(name, clickable, back){
      const el = document.createElement('div');
      el.className = 'tt-card' + (back ? ' tt-back' : '');
      if(!back){
        const img = document.createElement('img');
        img.src = basePath + name + ".png";
        img.onerror = () => img.src = placeholder(name);
        el.appendChild(img);
      }
      if(clickable) el.onclick = () => pick(name, el);
      return el;
    }

    function reveal(el, name){
      el.classList.remove('tt-back');
      el.innerHTML = "";
      const img = document.createElement('img');
      img.src = basePath + name + ".png";
      img.onerror = () => img.src = placeholder(name);
      el.appendChild(img);
    }

    function roundStart(){
      locked = true;
      index = 0;
      clearTimeout(timer);

      const len = Math.min(3 + round, 6);
      solution = shuffle(deck).slice(0, len);

      grid.innerHTML = "";
      prompt.textContent = "Memorize this sequence";
      note.textContent = "Tip: lock in the first few cards.";

      solution.forEach(n => grid.appendChild(card(n, false)));

      timer = setTimeout(()=>{
        grid.innerHTML = "";
        prompt.textContent = "Now click the cards in the correct order";
        shuffle(solution).forEach(n => grid.appendChild(card(n, true, true)));
        locked = false;
      }, 1500 + round * 250);
    }

    function pick(name, el){
      if(locked) return;

      if(el.classList.contains('tt-back')) reveal(el, name);

      if(name === solution[index]){
        score += 10;
        el.classList.add('disabled');
        index++;
        update();

        if(index === solution.length){
          round++;
          update();
          locked = true;
          prompt.textContent = "Nice! Next round…";
          timer = setTimeout(roundStart, 700);
        }
      } else {
        lives--;
        index = 0;
        update();

        if(lives <= 0){
          prompt.textContent = "Game Over";
          note.textContent = "Hit Restart to try again.";
          locked = true;
          return;
        }

        prompt.textContent = "Wrong — input reset. Try again!";
        [...grid.children].forEach(c=>{
          c.classList.remove('disabled');
          if(!c.classList.contains('tt-back')){
            c.innerHTML = "";
            c.classList.add('tt-back');
          }
        });
      }
    }

    btn.onclick = () => {
      score=0; lives=3; round=1;
      update();
      roundStart();
    };

    update();
    roundStart();
  });
})();
</script>
