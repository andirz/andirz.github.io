{% assign food_count  = include.food_count  | default: 0 %}
{% assign med_count   = include.med_count   | default: 0 %}
{% assign shop_count  = include.shop_count  | default: 0 %}
{% assign trash_count = include.trash_count | default: 0 %}
{% assign start_image = include.start_image | default: "start.png" %}

<style>
  .sort-section {
    background: white;
    border-radius: 24px;
    padding: 30px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);
    margin: 20px 0;
    text-align: center;
  }

  .sort-badges {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 18px;
    flex-wrap: wrap;
  }

  .sort-badge {
    background: #f8fafc;
    border: 1px solid rgba(0,0,0,0.07);
    border-radius: 999px;
    padding: 8px 16px;
    font-weight: 800;
    color: #0f172a;
  }

  .sort-image {
    width: 110px;
    height: 110px;
    margin: 22px auto 18px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    background-color: transparent;
    border: none;
    box-shadow: none;
    transition: transform 0.15s ease, filter 0.15s ease;
  }

  @keyframes blinkSoft {
    0%,100% { opacity: 1; }
    50% { opacity: 0.55; }
  }
  @keyframes blinkHard {
    0%,100% { opacity: 1; }
    50% { opacity: 0.2; }
  }

  .is-blinking { animation: blinkSoft 0.9s ease-in-out infinite; }
  .is-danger {
    animation: blinkHard 0.35s ease-in-out infinite;
    filter: drop-shadow(0 0 10px rgba(239,68,68,.6));
  }

  .sort-grid {
    display: grid;
    grid-template-columns: repeat(2,1fr);
    gap: 14px;
    max-width: 520px;
    margin: 0 auto;
  }

  .sort-box {
    background: #fff;
    border: 2px solid #f1f5f9;
    border-radius: 16px;
    padding: 18px;
    cursor: pointer;
    transition: all .2s;
    user-select: none;
  }

  .sort-box:hover {
    border-color: #3b82f6;
    background: #f0f9ff;
    transform: translateY(-2px);
  }

  .sort-box span {
    font-weight: 900;
    font-size: 1.05rem;
  }

  #sort-msg { height: 22px; font-weight: 900; margin-top: 14px; }
  .s-success { color:#22c55e }
  .s-error   { color:#ef4444 }
</style>

<div class="sort-section">
  <div class="sort-badges">
    <div class="sort-badge">Score: <span id="s-score">0</span></div>
    <div class="sort-badge">Lives: <span id="s-lives">❤️❤️❤️</span></div>
    <div class="sort-badge">Time: <span id="s-itemtime">5</span>s</div>
    <div class="sort-badge">Left: <span id="s-left">0</span></div>
  </div>

  <div id="sort-current" class="sort-image"></div>

  <div class="sort-grid">
    <div class="sort-box" onclick="checkSort('simsim')"><span>SimSim Store</span></div>
    <div class="sort-box" onclick="checkSort('nomnom')"><span>Sim-Nom-Nom</span></div>
    <div class="sort-box" onclick="checkSort('pharmacy')"><span>Pharmacy</span></div>
    <div class="sort-box" onclick="checkSort('trash')"><span>Trash Bin</span></div>
  </div>

  <div id="sort-msg"></div>
  <button id="s-start" class="btn mt-4" onclick="startSorting()">Start</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const IMG_BASE = "{{ site.baseurl }}/assets/img/games/shop/";
  const START_IMG = IMG_BASE + "{{ start_image }}";

  const FOOD_COUNT  = {{ food_count }};
  const MED_COUNT   = {{ med_count }};
  const SHOP_COUNT  = {{ shop_count }};
  const TRASH_COUNT = {{ trash_count }};

  const ITEM_TIME = 5;
  const MAX_LIVES = 3;

  let deck=[], score=0, lives=MAX_LIVES, active=false;
  let current=null, itemTime=ITEM_TIME, timer=null;

  const box = document.getElementById("sort-current");
  const elScore = s("s-score"), elLives=s("s-lives"),
        elItemTime=s("s-itemtime"), elLeft=s("s-left"), elMsg=s("sort-msg");

  function s(id){return document.getElementById(id)}
  const pad=n=>String(n).padStart(2,"0");
  const hearts=n=>"❤️".repeat(n);

  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}

  function buildDeck(){
    let a=[];
    for(let i=1;i<=FOOD_COUNT;i++)  a.push({img:`food${pad(i)}.png`,cat:"nomnom"});
    for(let i=1;i<=MED_COUNT;i++)   a.push({img:`med${pad(i)}.png`,cat:"pharmacy"});
    for(let i=1;i<=SHOP_COUNT;i++)  a.push({img:`shop${pad(i)}.png`,cat:"simsim"});
    for(let i=1;i<=TRASH_COUNT;i++) a.push({img:`trash${pad(i)}.png`,cat:"trash"});
    return shuffle(a);
  }

  function setImage(f){box.style.backgroundImage=`url("${IMG_BASE+f}")`}
  function ui(){elScore.innerText=score;elLives.innerText=hearts(lives);elItemTime.innerText=itemTime;elLeft.innerText=deck.length+(current?1:0)}

  function next(){
    if(!active) return;
    if(deck.length===0){end(true);return}
    current=deck.pop(); setImage(current.img);
    startTimer(); ui();
  }

  function startTimer(){
    clearInterval(timer); itemTime=ITEM_TIME;
    box.className="sort-image is-blinking";
    timer=setInterval(()=>{
      itemTime--;
      if(itemTime<=1) box.className="sort-image is-danger";
      if(itemTime<=0){clearInterval(timer); loseLife()}
      ui();
    },1000);
  }

  function loseLife(){
    lives--; elMsg.innerText="Too slow!"; elMsg.className="s-error";
    if(lives<=0){end(false);return}
    setTimeout(next,400);
  }

  function end(win){
    active=false; clearInterval(timer);
    setImage("{{ start_image }}");
    elMsg.innerText = win ? "All items sorted!" : "Game Over";
    elMsg.className = win ? "s-success" : "s-error";
    s("s-start").style.display="inline-block";
  }

  window.startSorting=()=>{
    deck=buildDeck(); score=0; lives=MAX_LIVES; active=true;
    s("s-start").style.display="none";
    setImage("{{ start_image }}"); setTimeout(next,300);
    ui();
  }

  window.checkSort=cat=>{
    if(!active||!current) return;
    clearInterval(timer);
    if(cat===current.cat) score+=10;
    else score=Math.max(0,score-5);
    next(); ui();
  }

  setImage("{{ start_image }}");
  elLeft.innerText=FOOD_COUNT+MED_COUNT+SHOP_COUNT+TRASH_COUNT;
});
</script>
