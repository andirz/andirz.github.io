<style>
  :root{
    --sims-green:#2ecc71; --sims-blue:#1e293b; --text-main:#0f172a;
    --transition:0.4s cubic-bezier(0.175,0.885,0.32,1.275);
  }
  .memory-container{font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:#f8fafc;border-radius:32px;padding:2rem;max-width:900px;margin:2rem auto;border:1px solid #e2e8f0;box-shadow:0 20px 25px -5px rgba(0,0,0,0.05);}
  .game-header{margin-bottom:1.25rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;}
  .game-title h2{font-weight:800;color:var(--text-main);margin:0;font-size:1.75rem;}
  .game-stats{display:flex;gap:0.75rem;align-items:center;flex-wrap:wrap;}
  .badge{background:#fff;padding:0.5rem 1rem;border-radius:50px;border:2px solid #e2e8f0;font-weight:600;color:var(--sims-blue);}
  .btn-sims{background:var(--sims-blue);color:#fff;border:none;padding:0.6rem 1.25rem;border-radius:12px;font-weight:600;cursor:pointer;transition:all 0.2s;}
  .btn-sims:hover{background:#334155;transform:translateY(-2px);}
  .grid-layout{display:grid;gap:12px;perspective:1000px; margin-top: 14px;}
  .m-card{aspect-ratio:1;cursor:pointer;position:relative;transform-style:preserve-3d;transition:transform var(--transition);}
  .m-card:hover{transform:scale(1.02);}
  .m-card.flipped{transform:rotateY(180deg);}
  .m-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:16px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);}
  .m-front{background:var(--sims-blue);color:#fff;font-size:1.5rem;border:2px solid rgba(255,255,255,0.1);}
  .m-back{background:#fff;transform:rotateY(180deg);padding:8px;border:3px solid var(--sims-green);}
  .m-back img{width:100%;height:100%;object-fit:contain;}
  .pp-error{margin-top:12px;color:#b91c1c;font-weight:600;}
</style>

<div class="memory-container" data-pack-picker>
  <div class="game-header">
    <div class="game-title">
      <h2>Pack Picker</h2>
      <p style="color:#64748b;margin:0;">Finde die Paare. Sul Sul!</p>
    </div>

    <div class="game-stats">
      <div class="badge" data-pp-mode>Mode: Easy (4×4)</div>
      <div class="badge" data-pp-status>Matches: 0 / 8</div>
      <div class="badge" data-pp-timer>Time: 00:00</div>

      <button class="btn-sims" type="button" data-pp-restart>Restart</button>
      <button class="btn-sims" type="button" data-pp-switch>Switch to 6×6</button>
    </div>
  </div>

  <div class="grid-layout" data-pp-grid></div>
  <div class="pp-error" data-pp-error style="display:none;"></div>
</div>

<script>
(function () {
  function boot() {
    const root = document.querySelector('[data-pack-picker]');
    if (!root) return;

    const basePath = "{{ site.baseurl }}/assets/img/packs/blue/";

    const grid = root.querySelector('[data-pp-grid]');
    const modeLabel = root.querySelector('[data-pp-mode]');
    const statusLabel = root.querySelector('[data-pp-status]');
    const timerLabel = root.querySelector('[data-pp-timer]');
    const btnRestart = root.querySelector('[data-pp-restart]');
    const btnSwitch = root.querySelector('[data-pp-switch]');
    const errorBox = root.querySelector('[data-pp-error]');

    if (!grid || !modeLabel || !statusLabel || !timerLabel || !btnRestart || !btnSwitch) {
      if (errorBox) {
        errorBox.style.display = "block";
        errorBox.textContent = "Pack Picker: DOM-Elemente wurden nicht gefunden (Include evtl. durch Markdown umgebaut).";
      }
      return;
    }

    const epPacks = Array.from({ length: 18 }, (_, i) => `ep${String(i + 1).padStart(2, "0")}`);
    const gpPacks = Array.from({ length: 12 }, (_, i) => `gp${String(i + 1).padStart(2, "0")}`);
    const allPacks = [...epPacks, ...gpPacks];

    const MODES = {
      easy: { key: "easy", cols: 4, pairs: 8,  labelUi: "Easy (4×4)", switchBtn: "Switch to 6×6" },
      hard: { key: "hard", cols: 6, pairs: 18, labelUi: "Hard (6×6)", switchBtn: "Switch to 4×4" }
    };

    let mode = MODES.easy; // Start immer 4x4
    let flippedCards = [];
    let lockBoard = false;
    let matches = 0;

    let timerId = null;
    let startMs = 0;

    function setGridColumns(cols) {
      grid.style.gridTemplateColumns = `repeat(${cols}, minmax(80px, 1fr))`;
    }

    function formatTime(ms) {
      const totalSec = Math.floor(ms / 1000);
      const m = Math.floor(totalSec / 60);
      const s = totalSec % 60;
      return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }

    function stopTimer() {
      if (timerId) clearInterval(timerId);
      timerId = null;
    }

    function startTimer() {
      stopTimer();
      startMs = Date.now();
      timerLabel.textContent = "Time: 00:00";
      timerId = setInterval(() => {
        timerLabel.textContent = `Time: ${formatTime(Date.now() - startMs)}`;
      }, 250);
    }

    function updateUi() {
      modeLabel.textContent = `Mode: ${mode.labelUi}`;
      statusLabel.textContent = `Matches: ${matches} / ${mode.pairs}`;
      btnSwitch.textContent = mode.switchBtn;
    }

    function initGame() {
      grid.innerHTML = "";
      flippedCards = [];
      lockBoard = false;
      matches = 0;

      setGridColumns(mode.cols);
      updateUi();
      startTimer();

      const selected = [...allPacks].sort(() => 0.5 - Math.random()).slice(0, mode.pairs);
      const deck = [...selected, ...selected].sort(() => 0.5 - Math.random());

      deck.forEach(pack => {
        const card = document.createElement("div");
        card.className = "m-card";
        card.dataset.pack = pack;

        card.innerHTML = `
          <div class="m-face m-front">?</div>
          <div class="m-face m-back">
            <img src="${basePath}${pack}.png" alt="${pack}" loading="lazy"
                 onerror="this.src='https://placehold.co/100?text=Pack'">
          </div>
        `;

        card.addEventListener("click", () => flipCard(card));
        grid.appendChild(card);
      });
    }

    function flipCard(card) {
      if (lockBoard || card === flippedCards[0] || card.classList.contains("flipped")) return;
      card.classList.add("flipped");
      flippedCards.push(card);
      if (flippedCards.length === 2) checkMatch();
    }

    function checkMatch() {
      lockBoard = true;
      const isMatch = flippedCards[0].dataset.pack === flippedCards[1].dataset.pack;

      if (isMatch) {
        matches++;
        updateUi();
        flippedCards = [];
        lockBoard = false;

        if (matches === mode.pairs) {
          stopTimer();
          setTimeout(() => alert(`Glückwunsch! Zeit: ${formatTime(Date.now() - startMs)}`), 350);
        }
      } else {
        setTimeout(() => {
          flippedCards.forEach(c => c.classList.remove("flipped"));
          flippedCards = [];
          lockBoard = false;
        }, 800);
      }
    }

    btnRestart.addEventListener("click", initGame);
    btnSwitch.addEventListener("click", () => {
      mode = (mode.key === "easy") ? MODES.hard : MODES.easy;
      initGame();
    });

    initGame();
  }

  // WICHTIG: erst starten, wenn DOM wirklich fertig ist (Markdown/Include-Situationen)
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot);
  } else {
    boot();
  }
})();
</script>
