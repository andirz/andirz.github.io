{% comment %} 
  ID aus dem Dateinamen extrahieren
{% endcomment %}
{% assign filename = page.path | split: "/" | last | replace: ".md", "" %}
{% assign current_id = page.mod_id | default: filename %}

{% comment %} Daten laden {% endcomment %}
{% assign mod = site.data.mods | where: "id", current_id | first %}
{% assign mod_full_name = mod.name | default: page.title %}
{% assign current_version = page.version | default: mod.version %}
{% assign final_reqs = page.requirements | default: mod.requirements %}
{% assign patreon_link = mod.patreon | default: site.data.globals.links.patreon %} 
{% assign kofi_link = site.data.globals.links.kofi %}
{% assign paypal_link = site.data.globals.links.paypal %}
{% assign cf_url = "https://www.curseforge.com/sims4/mods/" | append: (current_id | replace: '_', '-') %}

{% comment %} BILD-CHECK {% endcomment %}
{% assign expected_cover_path = "/assets/img/mods/" | append: current_id | append: "/cover.png" %}
{% assign cover_exists = false %}
{% for file in site.static_files %}
  {% if file.path == expected_cover_path %}
    {% assign cover_exists = true %}
    {% break %}
  {% endif %}
{% endfor %}

<div class="sticky-sidebar-wrapper" style="position: sticky; top: 20px;">
  
  <div class="sidebar-box" style="background: white; border: 2px solid #e2e8f0; border-radius: 16px; overflow: hidden; margin-bottom: 15px;">
    <div style="width: 100%; background: #f8fafc; border-bottom: 2px solid #3b82f6; display: flex; justify-content: center; align-items: center;">
      {% if cover_exists %}
        <img src="{{ expected_cover_path }}" alt="{{ mod_full_name }}" style="width: 100%; height: auto; display: block;">
      {% else %}
        <div style="padding: 30px 0; font-size: 50px; color: #3b82f6;">
           <i class="{{ page.icon | default: mod.icon | default: 'fas fa-box' }}"></i>
        </div>
      {% endif %}
    </div>

    <div style="padding: 15px; text-align: center;">
      <h3 style="font-size: 1.15rem; margin: 0; color: #0f172a; font-weight: 800; line-height: 1.2;">{{ mod_full_name }}</h3>
      <div style="margin-top: 6px; display: flex; justify-content: center; align-items: center; gap: 8px; color: #64748b; font-size: 0.8rem; font-weight: 600;">
        <span>v. {{ current_version }}</span>
        
        {% comment %} Dateityp-Icons mit Alt-Text (title) {% endcomment %}
        <div style="display: flex; gap: 6px; margin-left: 5px; border-left: 1px solid #e2e8f0; padding-left: 8px;">
          {% if page.files contains 'ts4script' %}
            <i class="fas {% if current_id == 'smart-core-script' %}fa-microchip{% else %}fa-code{% endif %}" title="Script Mod" style="color: #3b82f6;"></i>
          {% endif %}
          
          {% if page.files contains 'package' %}
            <i class="fas fa-box" title="Package File" style="color: #6366f1;"></i>
          {% endif %}
          
          {% if page.files contains 'bat' %}
            <i class="fas fa-terminal" title="Batch Tool" style="color: #1e293b;"></i>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {% comment %} 2. REQUIREMENTS BOX {% endcomment %}
  {% if final_reqs.size > 0 or page.packs.size > 0 %}
  <div class="sidebar-box" style="background: white; border: 2px solid #e2e8f0; border-radius: 16px; overflow: hidden; margin-bottom: 15px;">
    <div style="padding: 8px; background: #1e293b; text-align: center; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; color: #ffffff; letter-spacing: 1px;">Requirements</div>
    <div style="padding: 12px 15px;">
      {% if final_reqs.size > 0 %}
        <ul style="margin: 0; padding: 0; list-style: none;">
          {% for req_id in final_reqs %}
            {% assign dep_data = site.data.dependencies[req_id] %}
            <li style="margin-bottom: 8px; display: flex; align-items: center; font-size: 0.85rem;">
              <i class="{{ dep_data.icon | default: 'fas fa-puzzle-piece' }}" style="margin-right: 10px; color: #3b82f6; width: 14px; font-size: 0.75rem;"></i>
              <a href="{{ dep_data.url | default: '#' }}" style="color: #2563eb; font-weight: 700; text-decoration: none;">{{ dep_data.name | default: req_id }}</a>
            </li>
          {% endfor %}
        </ul>
      {% endif %}

      {% if page.packs.size > 0 %}
        <div style="border-top: 1px solid #f1f5f9; margin-top: 8px; padding-top: 10px; display: flex; align-items: center; gap: 8px;">
           <span style="font-size: 0.7rem; font-weight: 800; color: #64748b; text-transform: uppercase;">Packs:</span>
           <div style="display: flex; flex-wrap: wrap; gap: 4px;">
             {% for pack_id in page.packs %}
               <span style="background: #eff6ff; color: #1e40af; border: 1px solid #dbeafe; padding: 2px 5px; border-radius: 4px; font-size: 0.65rem; font-weight: 800;" title="{{ pack_id }}">{{ pack_id }}</span>
             {% endfor %}
           </div>
        </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {% comment %} 3. DOWNLOAD & SUPPORT {% endcomment %}
  <div class="sidebar-box" style="background: white; border: 2px solid #e2e8f0; border-radius: 16px; overflow: hidden;">
    <div style="padding: 12px; display: flex; flex-direction: column; gap: 8px;">
      {% unless page.curseforge_ban %}
        <a href="{{ cf_url }}" target="_blank" class="download-btn cf-btn"><i class="fab fa-firefox-browser"></i> <span>CurseForge</span></a>
      {% endunless %}
      <a href="{{ patreon_link }}" target="_blank" class="download-btn patreon-btn"><i class="fab fa-patreon"></i> <span>Patreon</span></a>

      <div style="margin-top: 5px; padding-top: 12px; border-top: 1px solid #f1f5f9; text-align: center;">
        <div style="display: flex; justify-content: center; gap: 20px;">
          <a href="{{ patreon_link }}" target="_blank" class="support-icon-link" style="color: #000000;" title="Patreon"><i class="fab fa-patreon"></i></a>
          <a href="{{ kofi_link }}" target="_blank" class="support-icon-link" style="color: #29abe0;" title="Ko-fi"><i class="fas fa-coffee"></i></a>
          <a href="{{ paypal_link }}" target="_blank" class="support-icon-link" style="color: #0070ba;" title="PayPal"><i class="fab fa-paypal"></i></a>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .download-btn {
    position: relative; display: flex; align-items: center; justify-content: center; 
    padding: 10px; border-radius: 10px; text-decoration: none; font-weight: 800; 
    font-size: 0.85rem; color: white !important;
    transition: filter 0.2s ease;
  }
  .download-btn:hover { filter: brightness(1.1); }
  .download-btn i { position: absolute; left: 15px; }
  .cf-btn { background: #f16436; }
  .patreon-btn { background: #1e293b; }

  .support-icon-link { 
    font-size: 1.15rem; 
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    display: inline-block; 
    text-decoration: none;
  }
  .support-icon-link:hover { transform: scale(1.4); }
</style>