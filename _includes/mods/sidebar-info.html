{% comment %}
  ID aus dem Dateinamen extrahieren
{% endcomment %}
{% assign filename = page.path | split: "/" | last | replace: ".md", "" %}
{% assign current_id = page.mod_id | default: filename %}

{% assign mod = site.data.mods | where: "id", current_id | first %}
{% assign mod_full_name = mod.name | default: page.title %}
{% assign current_version = page.version | default: mod.version %}
{% assign final_reqs = page.requirements | default: mod.requirements %}

{% assign patreon_link_raw = mod.patreon | default: site.data.globals.links.patreon %}
{% assign kofi_link_raw = site.data.globals.links.kofi %}
{% assign paypal_link_raw = site.data.globals.links.paypal %}

{% assign patreon_link = patreon_link_raw | strip %}
{% assign kofi_link = kofi_link_raw | strip %}
{% assign paypal_link = paypal_link_raw | strip %}

{% assign cf_slug = current_id | replace: '_', '-' %}
{% assign cf_url = "https://www.curseforge.com/sims4/mods/" | append: cf_slug | append: "/files/" %}

{% assign expected_cover_path = "/assets/img/mods/" | append: current_id | append: "/cover.png" %}
{% assign cover_exists = false %}
{% for file in site.static_files %}
  {% if file.path == expected_cover_path %}
    {% assign cover_exists = true %}
    {% break %}
  {% endif %}
{% endfor %}

{% assign has_reqs = final_reqs and final_reqs.size > 0 %}

<div class="sticky-sidebar-wrapper">

  <!-- MOD CARD -->
  <div class="sidebar-box">

    <!-- COVER -->
    <div class="sidebar-cover">
      {% if cover_exists %}
        <a href="{{ expected_cover_path }}" target="_blank" rel="noopener noreferrer">
          <img src="{{ expected_cover_path }}" alt="{{ mod_full_name }}">
        </a>
      {% else %}
        <div class="cover-fallback" aria-label="No cover image">
          <i class="{{ page.icon | default: mod.icon | default: 'fas fa-box' }}"></i>
        </div>
      {% endif %}
    </div>

    <!-- CONTENT -->
    <div class="sidebar-content">
      <h3>{{ mod_full_name }}</h3>

      <div class="meta">
        <span>v. {{ current_version }}</span>

        <div class="files">
          {% if page.files contains 'ts4script' %}
            <i class="fas fa-code" title="Script Mod"></i>
          {% endif %}
          {% if page.files contains 'bat' %}
            <i class="fas fa-terminal" title="Batch Tool"></i>
          {% endif %}
          {% unless page.files contains 'ts4script' or page.files contains 'bat' %}
            <i class="fas fa-box" title="Package Mod"></i>
          {% endunless %}
        </div>
      </div>
    </div>
  </div>

  <!-- REQUIREMENTS (nur Mods/Scripts, keine Packs) -->
  {% if has_reqs %}
  <div class="sidebar-box">

    <div class="sidebar-box-header">Requirements</div>

    <div class="sidebar-box-content">
      <ul class="requirements-list">
        {% for req_id in final_reqs %}
          {% assign dep = site.data.dependencies[req_id] %}
          {% assign dep_url = dep.url | strip %}
          <li>
            <i class="{{ dep.icon | default: 'fas fa-puzzle-piece' }}"></i>

            {% if dep_url and dep_url != "" %}
              <a href="{{ dep_url }}" target="_blank" rel="noopener noreferrer">
                {{ dep.name | default: req_id }}
              </a>
            {% else %}
              <span style="font-weight:700;">
                {{ dep.name | default: req_id }}
              </span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>

  </div>
  {% endif %}

  <!-- DOWNLOAD -->
  <div class="sidebar-box">
    <div class="download-wrap">

      {% unless page.curseforge_ban %}
        <a href="{{ cf_url }}" target="_blank" rel="noopener noreferrer" class="download-btn cf-btn">
          <i class="fab fa-firefox-browser"></i>
          <span>Download on CurseForge</span>
        </a>
      {% endunless %}

      {% if patreon_link and patreon_link != "" %}
        <a href="{{ patreon_link }}" target="_blank" rel="noopener noreferrer" class="download-btn patreon-btn">
          <i class="fab fa-patreon"></i>
          <span>Download on Patreon</span>
        </a>
      {% endif %}

    </div>
  </div>

  <!-- SUPPORT -->
  <div class="support-icons">
    {% if patreon_link and patreon_link != "" %}
      <a href="{{ patreon_link }}" target="_blank" rel="noopener noreferrer" title="Patreon" class="icon-btn patreon">
        <i class="fab fa-patreon"></i>
      </a>
    {% endif %}

    {% if kofi_link and kofi_link != "" %}
      <a href="{{ kofi_link }}" target="_blank" rel="noopener noreferrer" title="Ko-fi" class="icon-btn kofi">
        <i class="fas fa-coffee"></i>
      </a>
    {% endif %}

    {% if paypal_link and paypal_link != "" %}
      <a href="{{ paypal_link }}" target="_blank" rel="noopener noreferrer" title="PayPal" class="icon-btn paypal">
        <i class="fab fa-paypal"></i>
      </a>
    {% endif %}
  </div>

</div>

<style>
:root{ --soft-black:#1f2937; }

/* LAYOUT */
.sticky-sidebar-wrapper{
  position:sticky;
  top:20px;
}

/* BOX */
.sidebar-box{
  background:#fff;
  border:1px solid var(--soft-black);
  border-radius:14px;
  overflow:hidden;
  margin-bottom:14px;
}

.sidebar-box-header{
  background:var(--soft-black);
  color:#fff;
  font-size:0.65rem;
  font-weight:800;
  text-align:center;
  padding:7px;
  text-transform:uppercase;
  letter-spacing:1px;
}

.sidebar-box-content{
  padding:12px 14px;
}

/* COVER (10:9 – niedriger als Quadrat, höher als 4:3) */
.sidebar-cover{
  position:relative;
  aspect-ratio: 10 / 9;
  overflow:hidden;
  border-bottom:1px solid var(--soft-black);
}

.sidebar-cover > a,
.sidebar-cover > a > img{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
}

.sidebar-cover > a > img{
  object-fit:cover;
}

.cover-fallback{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#f3f4f6;
  color:var(--soft-black);
}

.cover-fallback i{
  font-size:56px;
}

/* CONTENT */
.sidebar-content{
  padding:8px 14px 12px;
  text-align:center;
}

.sidebar-content h3{
  margin:2px 0 4px;
  font-size:1.05rem;
  line-height:1.2;
}

.meta{
  margin-top:2px;
  font-size:0.75rem;
  color:#6b7280;
  display:flex;
  justify-content:center;
  gap:6px;
  align-items:center;
}

.files{
  display:flex;
  gap:6px;
  border-left:1px solid var(--soft-black);
  padding-left:8px;
}

.files i{
  font-size:0.8rem;
}

/* REQUIREMENTS */
.requirements-list{
  list-style:none;
  padding:0;
  margin:0;
}

.requirements-list li{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:0.85rem;
  margin-bottom:8px;
}

.requirements-list a{
  font-weight:700;
  text-decoration:none;
  color:var(--link-color, #2563eb);
}

.requirements-list a:hover{
  text-decoration:underline;
  color:var(--link-color-hover, #1d4ed8);
}

/* DOWNLOAD */
.download-wrap{
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.download-btn{
  position:relative;
  padding:10px 14px;
  border-radius:9px;
  font-weight:800;
  font-size:0.85rem;
  color:#fff !important;
  text-decoration:none;
  display:flex;
  align-items:center;
  justify-content:center;
  border:1px solid transparent;
}

.download-btn i{
  position:absolute;
  left:14px;
  font-size:1rem;
}

.download-btn:hover{
  border-color:rgba(255,255,255,0.55);
}

.cf-btn{ background:#f16436; }
.patreon-btn{ background:#1e293b; }

/* SUPPORT */
.support-icons{
  display:flex;
  justify-content:center;
  gap:18px;
  padding:6px 0 2px;
}

.support-icons .icon-btn{
  width:38px;
  height:38px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:999px;
  text-decoration:none;
  transition:transform 140ms ease, filter 140ms ease, box-shadow 140ms ease;
}

.support-icons .icon-btn i{
  font-size:1.25rem;
}

.support-icons .icon-btn.patreon{
  background:#111;
  color:#fff;
}

.support-icons .icon-btn.paypal{
  background:#1f6feb;
  color:#fff;
}

.support-icons .icon-btn.kofi{
  background:#fff;
  color:#ff5a5f;
  border:1.5px solid #111;
}

.support-icons .icon-btn:hover{
  transform:scale(1.18);
  box-shadow:0 6px 14px rgba(0,0,0,0.14);
}
</style>
