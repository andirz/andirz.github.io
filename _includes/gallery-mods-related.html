{% assign current_id = page.mod_id %}
{% assign current_cats = page.categories %}
{% assign gallery_count = 0 %}
{% assign max_items = 3 %}
{% assign shown_ids = current_id | split: "," %}

<section class="gallery-wrapper gallery-related" style="margin-top: 80px; padding-top: 40px; border-top: 1px solid #f1f5f9;">
  <div style="margin-bottom: 30px;">
    <h2 style="font-size: 1.6rem; font-weight: 800; color: #1e293b; margin: 0; font-style: italic;">Recommended Mods</h2>
    <p style="color: #64748b; margin: 5px 0 0 0;">Check out more of my work:</p>
  </div>

  <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px;">
    
    {% comment %} STUFE 1 & 2: Suche nach Übereinstimmungen (priorisiert nach Reihenfolge deiner Kategorien) {% endcomment %}
    {% for cat in current_cats %}
      {% assign clean_cat = cat | strip %}
      {% for g_mod in site.data.mods %}
        {% unless shown_ids contains g_mod.id %}
          {% if g_mod.categories contains clean_cat %}
            {% if gallery_count < max_items %}
              {% assign gallery_count = gallery_count | plus: 1 %}
              {% assign shown_ids = shown_ids | push: g_mod.id %}
              {% include gallery-card-item.html mod_data=g_mod is_new=true %}
            {% endif %}
          {% endif %}
        {% endunless %}
      {% endfor %}
    {% endfor %}

    {% comment %} STUFE 3: Random/Rest-Auffüllung (falls weniger als 3 gefunden wurden) {% endcomment %}
    {% if gallery_count < max_items %}
      {% for g_mod in site.data.mods %}
        {% unless shown_ids contains g_mod.id %}
          {% if gallery_count < max_items %}
            {% assign gallery_count = gallery_count | plus: 1 %}
            {% assign shown_ids = shown_ids | push: g_mod.id %}
            {% include gallery-card-item.html mod_data=g_mod is_new=false %}
          {% endif %}
        {% endunless %}
      {% endfor %}
    {% endif %}

  </div>
</section>
