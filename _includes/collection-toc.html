{% comment %}
  Include: collection-toc.html

  Builds a TOC-like list from any Jekyll collection and places it top-right (sticky).

  Parameters:
  - collection: required (e.g. "support", "wiki", "tutorials")
  - title:      optional (default: "On this page")
  - sort:       optional (default: "title")
  - order:      optional "asc" | "desc" (default: "asc")
  - where_key:  optional (e.g. "toc")
  - where_val:  optional (e.g. true)
  - limit:      optional number
  - show_desc:  optional true|false (default: false)
  - max_desc:   optional (default: 90)
  - width:      optional (default: "min(320px, 36%)") e.g. "280px" or "30%" or "min(300px, 32%)"
  - class:      optional extra class on wrapper

  Notes:
  - Current page is INCLUDED but rendered as dark, non-linked text.
  - Icons are taken from each page frontmatter "icon", with a fallback.
{% endcomment %}

{% assign _col = include.collection | to_s %}
{% assign _title = include.title | default: "On this page" %}
{% assign _sort = include.sort | default: "title" %}
{% assign _order = include.order | default: "asc" %}
{% assign _show_desc = include.show_desc %}
{% if _show_desc == nil %}{% assign _show_desc = false %}{% endif %}
{% assign _max_desc = include.max_desc | default: 90 %}
{% assign _class = include.class | default: "" %}
{% assign _width = include.width | default: "min(320px, 36%)" %}

{% assign _items = site[_col] %}

{% if _items == nil %}
  <!-- collection-toc: Collection '{{ _col }}' not found -->
{% else %}

  {% if include.where_key and include.where_val %}
    {% assign _items = _items | where: include.where_key, include.where_val %}
  {% endif %}

  {% if _sort and _sort != "" %}
    {% assign _items = _items | sort: _sort %}
  {% endif %}

  {% if _order == "desc" %}
    {% assign _items = _items | reverse %}
  {% endif %}

  {% if include.limit %}
    {% assign _items = _items | slice: 0, include.limit %}
  {% endif %}

  <aside class="collection-toc {{ _class | escape }}" style="width: {{ _width }};">
    <div class="collection-toc__head">
      <span class="collection-toc__title">{{ _title }}</span>
    </div>

    <ul class="collection-toc__list">
      {% for p in _items %}
        {% assign is_current = p.url == page.url %}
        {% assign icon = p.icon | default: "fas fa-file-alt" %}

        <li class="collection-toc__item {% if is_current %}is-current{% endif %}">
          {% if is_current %}
            <span class="collection-toc__current">
              <i class="{{ icon }}" aria-hidden="true"></i>
              <span class="collection-toc__text">{{ p.toc_title | default: p.title }}</span>
            </span>
          {% else %}
            <a class="collection-toc__link" href="{{ p.url | relative_url }}">
              <i class="{{ icon }}" aria-hidden="true"></i>
              <span class="collection-toc__text">{{ p.toc_title | default: p.title }}</span>
            </a>
          {% endif %}

          {% if _show_desc and p.description %}
            <div class="collection-toc__desc">
              {% assign d = p.description | strip_html | strip_newlines %}
              {% if d.size > _max_desc %}
                {{ d | slice: 0, _max_desc }}â€¦
              {% else %}
                {{ d }}
              {% endif %}
            </div>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </aside>

  <style>
    /* Collection TOC (top-right, list style) */
    .collection-toc{
      float: right;
      margin: 0 0 1rem 1.25rem;

      position: sticky;
      top: 1rem;

      padding: 0.85rem 0.9rem;
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 14px;
      background: var(--card-bg, #fff);
      box-shadow: 0 10px 24px rgba(0,0,0,0.06);
    }

    .collection-toc__head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 0.65rem;
      padding-bottom: 0.55rem;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .collection-toc__title{
      font-weight: 650;
      letter-spacing: -0.2px;
    }

    .collection-toc__list{
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 0.35rem;
    }

    .collection-toc__item{
      margin: 0;
      padding: 0;
    }

    .collection-toc__link,
    .collection-toc__current{
      display: flex;
      align-items: center;
      gap: 0.55rem;
      line-height: 1.25;
    }

    .collection-toc__link{
      text-decoration: none;
    }

    .collection-toc i{
      font-size: 0.95rem;
      opacity: 0.75;
      width: 1.1rem;
      text-align: center;
    }

    .collection-toc__text{
      display: inline-block;
    }

    .collection-toc__desc{
      margin-top: 0.15rem;
      margin-left: calc(1.1rem + 0.55rem);
      font-size: 0.88rem;
      opacity: 0.75;
    }

    /* Current page: dark + not linked */
    .collection-toc__current{
      color: rgba(0,0,0,0.45);
      cursor: default;
      font-weight: 500;
    }

    .collection-toc__item.is-current{
      opacity: 0.8;
    }

    .collection-toc__item.is-current i{
      opacity: 0.4;
    }

    .collection-toc__link:hover i{
      opacity: 1;
    }

    /* Mobile: no floating/sticky sidebar */
    @media (max-width: 980px){
      .collection-toc{
        float: none;
        width: 100% !important;
        margin: 0 0 1rem 0;
        position: relative;
        top: auto;
      }
    }

    /* Optional ultra-compact on very small screens */
    /*
    @media (max-width: 420px){
      .collection-toc__text{ display:none; }
    }
    */
  </style>

{% endif %}
