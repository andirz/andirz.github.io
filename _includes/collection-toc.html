{% comment %}
  Include: collection-toc.html

  Inline TOC block for collections.
  Integrated into content flow (not sticky, not floating).

  Parameters:
  - collection:  required (e.g. "support", "wiki", "tutorials")
  - title:       optional (default: "On this page")
  - sort:        optional (default: "order")
  - order:       optional "asc" | "desc" (default: "asc")
  - where_key:   optional (e.g. "toc")
  - where_val:   optional (e.g. true)
  - limit:       optional number
  - show_desc:   optional true|false (default: false)
  - show_icons:  optional true|false (default: true)
  - max_desc:    optional (default: 90)
  - width:       optional (default: "600px")
{% endcomment %}

{% assign _col = include.collection | to_s %}
{% assign _title = include.title | default: "On this page" %}
{% assign _sort = include.sort | default: "order" %}
{% assign _order = include.order | default: "asc" %}

{% assign _show_desc = include.show_desc %}
{% if _show_desc == nil %}{% assign _show_desc = false %}{% endif %}

{% assign _show_icons = include.show_icons %}
{% if _show_icons == nil %}{% assign _show_icons = true %}{% endif %}

{% assign _max_desc = include.max_desc | default: 90 %}
{% assign _width = include.width | default: "600px" %}

{% assign _items = site[_col] %}

{% if _items != nil %}

  {% if include.where_key %}
    {% assign _items = _items | where: include.where_key, include.where_val %}
  {% endif %}

  {% assign _items = _items | sort: _sort %}
  {% if _order == "desc" %}
    {% assign _items = _items | reverse %}
  {% endif %}

  {% if include.limit %}
    {% assign _items = _items | slice: 0, include.limit %}
  {% endif %}

  <aside class="collection-toc" style="max-width: {{ _width }};">
    <div class="collection-toc__head">
      <span class="collection-toc__title">{{ _title }}</span>
    </div>

    <ul class="collection-toc__list {% if _show_icons == false %}no-icons{% endif %}">
      {% for p in _items %}
        {% assign icon = p.icon | default: "fas fa-file-alt" %}

        <li class="collection-toc__item">
          <a class="collection-toc__link" href="{{ p.url | relative_url }}">
            {% if _show_icons %}
              <i class="{{ icon }}" aria-hidden="true"></i>
            {% endif %}
            <span class="collection-toc__text">
              {{ p.toc_title | default: p.title }}
            </span>
          </a>

          {% if _show_desc and p.description %}
            <div class="collection-toc__desc">
              {% assign d = p.description | strip_html | strip_newlines %}
              {% if d.size > _max_desc %}
                {{ d | slice: 0, _max_desc }}â€¦
              {% else %}
                {{ d }}
              {% endif %}
            </div>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </aside>

  <style>
    /* Soft badge / hint block */
    .collection-toc{
      margin: 0 0 1.5rem 0;
      padding: 0.75rem 0.85rem;

      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      background: rgba(0,0,0,0.015);

      position: relative;
    }

    .collection-toc__head{
      margin-bottom: 0.5rem;
    }

    .collection-toc__title{
      font-weight: 600;
      font-size: 0.95rem;
      opacity: 0.85;
    }

    .collection-toc__list{
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 0.35rem;
    }

    .collection-toc__link{
      display: flex;
      align-items: center;
      gap: 0.5rem;
      line-height: 1.25;
      text-decoration: none;
      cursor: pointer;
    }

    .collection-toc__list.no-icons .collection-toc__link{
      gap: 0;
    }

    .collection-toc i{
      font-size: 0.9rem;
      opacity: 0.6;
      width: 1.05rem;
      text-align: center;
      flex: 0 0 auto;
    }

    .collection-toc__text{
      display: inline-block;
    }

    .collection-toc__desc{
      margin-left: calc(1.05rem + 0.5rem);
      font-size: 0.88rem;
      opacity: 0.7;
    }

    .collection-toc__list.no-icons .collection-toc__desc{
      margin-left: 0;
    }
  </style>

{% endif %}
